<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mug Studio 2.2</title>
    
    <!-- ==========================================
         DEPENDÊNCIAS EXTERNAS
    =========================================== -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- ==========================================
         ESTILOS (CSS)
    =========================================== -->
    <style>
        body {
            background-color: #f0f0f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; 
            user-select: none;
        }

        /* --- UI Retrô (Win95 Style) --- */
        .win95-box {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #dfdfdf #404040 #404040 #dfdfdf;
            padding: 4px;
        }
        
        .sidebar {
            background-color: #c0c0c0;
            border-right: 2px solid #808080;
            box-shadow: inset -1px -1px 0px #404040, inset 1px 1px 0px #dfdfdf;
        }

        .tool-btn {
            background-color: #c0c0c0;
            border: 2px solid;
            border-color: #dfdfdf #404040 #404040 #dfdfdf;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.1s;
        }
        .tool-btn:active, .tool-btn.active {
            border-color: #404040 #dfdfdf #dfdfdf #404040;
            background-color: #e0e0e0;
        }

        /* --- Canvas & 3D --- */
        .canvas-container {
            background-color: #808080;
            padding: 20px;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            position: relative;
        }
        canvas#drawingCanvas {
            background-color: white;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
        }
        #renderer-container {
            width: 100%; height: 300px;
            background: linear-gradient(to bottom, #e0e0e0, #ffffff);
            border-top: 2px solid #808080;
            position: relative;
        }

        /* --- Componentes Flutuantes --- */
        .floating-panel {
            position: absolute; top: 60px; left: 100px; width: 250px;
            background: #c0c0c0;
            border: 2px solid #dfdfdf; border-right-color: #404040; border-bottom-color: #404040;
            box-shadow: 4px 4px 10px rgba(0,0,0,0.3);
            z-index: 50; display: none; 
        }
        .panel-header {
            background: #000080; color: white; padding: 2px 4px;
            font-weight: bold; font-size: 12px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: grab;
        }
        #imageToolbar {
            display: none; position: absolute; top: 10px; left: 50%;
            transform: translateX(-50%);
            background: #ffffe0; border: 1px solid #000;
            padding: 5px 10px; gap: 10px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            font-size: 12px; z-index: 40; align-items: center;
        }

        /* --- Loading Spinner --- */
        #loadingOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100;
            justify-content: center; align-items: center; color: white;
            flex-direction: column; text-align: center;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- OVERLAY LOADING -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <span id="loadingText" class="font-bold text-lg">Processando...</span>
        <span class="text-sm text-gray-300 mt-2">Não feche a janela.</span>
    </div>

    <!-- HEADER -->
    <header class="bg-[#000080] text-white p-2 flex justify-between items-center select-none">
        <div class="font-bold tracking-wide pl-2 flex items-center gap-2">
            <i class="fas fa-coffee"></i> Mug Studio v2.2
        </div>
        <button class="win95-box text-black px-2 font-bold hover:bg-red-200" onclick="window.location.reload()">X</button>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- SIDEBAR (FERRAMENTAS) -->
        <aside class="sidebar w-20 flex flex-col items-center py-4 gap-3 select-none z-10">
            <div class="flex flex-col items-center w-full px-2">
                <label class="text-xs mb-1 font-bold">Cor</label>
                <input type="color" id="colorPicker" value="#000000" class="w-10 h-8 cursor-pointer border-2 border-gray-600">
            </div>
            <div class="flex flex-col items-center w-full px-2">
                <label class="text-xs mb-1 font-bold">Pincel</label>
                <input type="range" id="brushSize" min="1" max="20" value="5" class="w-14">
            </div>
            <hr class="w-10 border-gray-500 my-2">
            
            <button id="btnPencil" class="tool-btn w-10 h-10 active" title="Lápis"><i class="fas fa-pencil-alt"></i></button>
            <button id="btnEraser" class="tool-btn w-10 h-10" title="Borracha"><i class="fas fa-eraser"></i></button>
            <button id="btnUndo" class="tool-btn w-10 h-10 text-purple-800" title="Desfazer (Ctrl+Z)"><i class="fas fa-undo"></i></button>
            
            <div class="relative group">
                <button class="tool-btn w-10 h-10" title="Importar Imagem" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-folder-open text-yellow-700"></i>
                </button>
                <input type="file" id="fileInput" accept="image/*" class="hidden">
            </div>
            
            <button id="btnFilters" class="tool-btn w-10 h-10" title="Filtros"><i class="fas fa-sliders-h text-blue-800"></i></button>
            
            <div class="flex-grow"></div>
            <button id="btnClear" class="tool-btn w-10 h-10 text-red-600 mb-2" title="Limpar"><i class="fas fa-trash-alt"></i></button>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col bg-[#808080] relative">
            
            <!-- Janela de Filtros -->
            <div id="filterPanel" class="floating-panel p-2">
                <div class="panel-header mb-2" id="filterPanelHeader">
                    <span>Filtros</span> <button id="closeFilters" class="hover:text-red-300">x</button>
                </div>
                <div class="space-y-2">
                    <div class="slider-group"><label>Blur</label><input type="range" id="filterBlur" class="filter-input" min="0" max="10" value="0" step="0.5"></div>
                    <div class="slider-group">
                        <label>Modo</label>
                        <select id="filterMode" class="filter-input w-full text-xs p-1 border">
                            <option value="normal">Normal</option>
                            <option value="grayscale">P&B</option>
                            <option value="sepia">Sépia</option>
                            <option value="invert">Inverter</option>
                        </select>
                    </div>
                    <hr class="border-gray-500">
                    <div class="slider-group"><label class="text-red-600">Vermelho</label><input type="range" id="channelR" class="filter-input" min="0" max="200" value="100"></div>
                    <div class="slider-group"><label class="text-green-600">Verde</label><input type="range" id="channelG" class="filter-input" min="0" max="200" value="100"></div>
                    <div class="slider-group"><label class="text-blue-600">Azul</label><input type="range" id="channelB" class="filter-input" min="0" max="200" value="100"></div>
                </div>
                <div class="flex gap-2 mt-3">
                    <button id="btnCancelFilter" class="w-1/2 win95-box text-xs font-bold text-red-700">Cancelar</button>
                    <button id="btnConfirmFilter" class="w-1/2 win95-box text-xs font-bold text-green-700">OK</button>
                </div>
            </div>

            <!-- Área Canvas -->
            <div class="flex-1 canvas-container relative">
                <div id="imageToolbar" class="flex">
                    <span class="font-bold mr-2"><i class="fas fa-arrows-alt"></i> Ajuste a Imagem</span>
                    <button id="btnConfirmImg" class="text-green-600 font-bold px-2"><i class="fas fa-check"></i></button>
                    <button id="btnDiscardImg" class="text-red-600 font-bold px-2"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-white text-xs mb-1 font-mono tracking-widest">ÁREA DE SUBLIMAÇÃO</span>
                    <canvas id="drawingCanvas" width="800" height="360"></canvas>
                </div>
            </div>

            <!-- Rodapé Controles -->
            <div class="bg-[#c0c0c0] p-3 border-t-2 border-gray-400 flex flex-wrap justify-between items-center gap-4 z-20">
                <div class="flex items-center gap-2 flex-grow">
                     <label class="text-xs font-bold whitespace-nowrap">Dados:</label>
                     <div class="win95-box bg-white px-2 flex gap-2 w-full max-w-lg">
                        <input type="email" id="userEmail" placeholder="E-mail (Para compartilhar)" class="outline-none text-sm w-1/2 bg-transparent">
                        <div class="w-[1px] bg-gray-400"></div>
                        <input type="tel" id="userPhone" placeholder="+55 (41) 9..." class="outline-none text-sm w-1/2 bg-transparent">
                     </div>
                </div>
                <div class="flex gap-2">
                    <button id="btnReset" class="win95-box px-4 py-1 font-bold hover:bg-red-100 text-sm"><i class="fas fa-bomb mr-1"></i> Reset</button>
                    <button id="btnApply" class="win95-box px-4 py-1 font-bold hover:bg-blue-100 text-sm"><i class="fas fa-cube mr-1"></i> 3D</button>
                    <button id="btnSend" class="win95-box px-4 py-1 font-bold hover:bg-green-100 text-sm whitespace-nowrap"><i class="fas fa-save mr-1"></i> Salvar Pedido</button>
                </div>
            </div>

            <!-- Visualização 3D -->
            <div id="renderer-container">
                <div class="absolute top-2 left-2 bg-black/50 text-white text-xs px-2 py-1 rounded pointer-events-none z-10">Preview 3D</div>
            </div>
        </main>
    </div>

    <!-- ==========================================
         LÓGICA JAVASCRIPT
    =========================================== -->
    <script>
        // === CONFIGURAÇÃO GLOBAL ===
        // URL DO GOOGLE APPS SCRIPT (Certifique-se de que está atualizado)
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbysQfI9ECyMASiUvqoyHVY8XNKB1eUQj04gK1y3tLjzVaRRXl4xt2dVclmV-hhKbDoL/exec";
        
        // Elementos DOM Principais
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');

        // Estado da Aplicação
        const state = {
            isDrawing: false,
            tool: 'pencil',
            history: [],
            historyStep: -1,
            floatingImg: null,
            drag: { active: false, startX: 0, startY: 0 }
        };

        // Inicialização
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        saveToHistory();

        // === MÓDULO 1: HISTÓRICO (UNDO) ===
        function saveToHistory() {
            state.historyStep++;
            if (state.historyStep < state.history.length) {
                state.history.length = state.historyStep;
            }
            state.history.push(canvas.toDataURL());
            if (state.history.length > 15) {
                state.history.shift();
                state.historyStep--;
            }
        }

        function undo() {
            if (state.historyStep > 0) {
                state.historyStep--;
                const img = new Image();
                img.src = state.history[state.historyStep];
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                }
            }
        }
        document.getElementById('btnUndo').addEventListener('click', undo);
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
        });

        // === MÓDULO 2: FERRAMENTAS DE DESENHO ===
        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
            const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function handleStart(e) {
            if(e.type === 'touchstart') e.preventDefault(); 
            const pos = getMousePos(e);

            if (state.floatingImg) {
                const img = state.floatingImg;
                if (pos.x >= img.x && pos.x <= img.x + img.width &&
                    pos.y >= img.y && pos.y <= img.y + img.height) {
                    state.drag.active = true;
                    state.drag.startX = pos.x - img.x;
                    state.drag.startY = pos.y - img.y;
                    canvas.style.cursor = 'grabbing';
                }
                return;
            }

            state.isDrawing = true;
            state.lastX = pos.x; state.lastY = pos.y;
            
            ctx.beginPath();
            ctx.fillStyle = state.tool === 'eraser' ? '#ffffff' : document.getElementById('colorPicker').value;
            ctx.arc(state.lastX, state.lastY, document.getElementById('brushSize').value / 2, 0, Math.PI * 2);
            ctx.fill();
        }

        function handleMove(e) {
            if(e.type === 'touchmove') e.preventDefault();
            const pos = getMousePos(e);

            if (state.floatingImg && state.drag.active) {
                state.floatingImg.x = pos.x - state.drag.startX;
                state.floatingImg.y = pos.y - state.drag.startY;
                renderFloatingOverlay();
                return;
            }

            if (!state.isDrawing || state.floatingImg) return;

            ctx.beginPath();
            ctx.moveTo(state.lastX, state.lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            ctx.lineWidth = document.getElementById('brushSize').value;
            ctx.strokeStyle = state.tool === 'eraser' ? '#ffffff' : document.getElementById('colorPicker').value;
            ctx.stroke();
            state.lastX = pos.x; state.lastY = pos.y;
        }

        function handleEnd() {
            if (state.isDrawing && !state.floatingImg) saveToHistory();
            state.isDrawing = false;
            state.drag.active = false;
            canvas.style.cursor = state.floatingImg ? 'move' : 'crosshair';
        }

        ['mousedown', 'touchstart'].forEach(ev => canvas.addEventListener(ev, handleStart));
        ['mousemove', 'touchmove'].forEach(ev => canvas.addEventListener(ev, handleMove));
        ['mouseup', 'mouseout', 'touchend'].forEach(ev => canvas.addEventListener(ev, handleEnd));
        
        canvas.addEventListener('wheel', (e) => {
            if (state.floatingImg) {
                e.preventDefault();
                const scale = e.deltaY > 0 ? 0.9 : 1.1;
                const img = state.floatingImg;
                const newW = img.width * scale;
                const newH = img.height * scale;
                img.x += (img.width - newW) / 2;
                img.y += (img.height - newH) / 2;
                img.width = newW; img.height = newH;
                renderFloatingOverlay();
            }
        }, { passive: false });

        // === MÓDULO 3: IMAGEM FLUTUANTE ===
        function renderFloatingOverlay() {
            if (!state.floatingImg) return;
            const bgImg = new Image();
            bgImg.src = state.history[state.historyStep];
            bgImg.onload = () => {
                ctx.clearRect(0,0,canvas.width, canvas.height);
                ctx.drawImage(bgImg, 0, 0);
                const f = state.floatingImg;
                ctx.save();
                ctx.drawImage(f.img, f.x, f.y, f.width, f.height);
                ctx.strokeStyle = "#00f"; ctx.lineWidth = 2; ctx.setLineDash([5, 5]);
                ctx.strokeRect(f.x, f.y, f.width, f.height);
                ctx.restore();
            }
        }

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const aspect = img.width / img.height;
                        const h = canvas.height * 0.8;
                        state.floatingImg = { img: img, x: (canvas.width - h*aspect)/2, y: (canvas.height - h)/2, width: h*aspect, height: h };
                        document.getElementById('imageToolbar').style.display = 'flex';
                        renderFloatingOverlay();
                    }
                    img.src = evt.target.result;
                }
                reader.readAsDataURL(file);
                e.target.value = '';
            }
        });

        document.getElementById('btnConfirmImg').addEventListener('click', () => {
            if (state.floatingImg) {
                const bgImg = new Image();
                bgImg.src = state.history[state.historyStep];
                bgImg.onload = () => {
                    ctx.drawImage(bgImg, 0, 0);
                    ctx.drawImage(state.floatingImg.img, state.floatingImg.x, state.floatingImg.y, state.floatingImg.width, state.floatingImg.height);
                    state.floatingImg = null;
                    document.getElementById('imageToolbar').style.display = 'none';
                    saveToHistory();
                }
            }
        });

        document.getElementById('btnDiscardImg').addEventListener('click', () => {
            state.floatingImg = null;
            document.getElementById('imageToolbar').style.display = 'none';
            const img = new Image();
            img.src = state.history[state.historyStep];
            img.onload = () => ctx.drawImage(img, 0, 0);
        });

        // === MÓDULO 4: FILTROS E AJUSTES ===
        let originalFilterState = null;
        
        document.getElementById('btnFilters').addEventListener('click', () => {
            if(state.floatingImg) return alert("Fixe a imagem antes.");
            document.getElementById('filterPanel').style.display = 'block';
            originalFilterState = canvas.toDataURL();
        });

        const updateFilter = () => {
            if(!originalFilterState) return;
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0,0,canvas.width, canvas.height);
                ctx.save();
                const blur = document.getElementById('filterBlur').value;
                const mode = document.getElementById('filterMode').value;
                let filterStr = `blur(${blur}px)`;
                if(mode !== 'normal') filterStr += ` ${mode === 'grayscale' ? 'grayscale' : mode}(100%)`;
                ctx.filter = filterStr;
                ctx.drawImage(img, 0, 0);
                ctx.restore();

                const r = document.getElementById('channelR').value / 100;
                const g = document.getElementById('channelG').value / 100;
                const b = document.getElementById('channelB').value / 100;
                
                if(r !== 1 || g !== 1 || b !== 1) {
                    const idata = ctx.getImageData(0,0,canvas.width, canvas.height);
                    for(let i=0; i<idata.data.length; i+=4) {
                        idata.data[i] *= r; idata.data[i+1] *= g; idata.data[i+2] *= b;
                    }
                    ctx.putImageData(idata, 0, 0);
                }
            };
            img.src = originalFilterState;
        };

        document.querySelectorAll('.filter-input').forEach(el => el.addEventListener('input', updateFilter));
        
        document.getElementById('btnConfirmFilter').addEventListener('click', () => {
            saveToHistory();
            document.getElementById('filterPanel').style.display = 'none';
            originalFilterState = null;
        });
        
        document.getElementById('btnCancelFilter').addEventListener('click', () => {
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0);
            img.src = originalFilterState;
            document.getElementById('filterPanel').style.display = 'none';
            originalFilterState = null;
        });

        // Controles de Ferramenta
        const setTool = (t, id) => {
            if(state.floatingImg) return;
            state.tool = t;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        document.getElementById('btnPencil').onclick = () => setTool('pencil', 'btnPencil');
        document.getElementById('btnEraser').onclick = () => setTool('eraser', 'btnEraser');
        document.getElementById('btnClear').onclick = () => {
            if(confirm('Limpar tela?')) {
                ctx.fillStyle = "white"; ctx.fillRect(0,0,canvas.width,canvas.height);
                state.floatingImg = null;
                saveToHistory();
            }
        };

        // === MÓDULO 5: VISUALIZAÇÃO 3D (THREE.JS) ===
        let scene, camera, renderer, printMesh;
        function init3D() {
            const container = document.getElementById('renderer-container');
            scene = new THREE.Scene(); scene.background = new THREE.Color(0xe0e0e0);
            camera = new THREE.PerspectiveCamera(35, container.clientWidth/container.clientHeight, 0.1, 1000);
            camera.position.set(0, 1.5, 4); camera.lookAt(0,0,0);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            const light = new THREE.DirectionalLight(0xffffff, 0.8);
            light.position.set(2, 5, 5); scene.add(light); scene.add(new THREE.AmbientLight(0xffffff, 0.6));

            const group = new THREE.Group();
            
            // Corpo e Alça
            const matWhite = new THREE.MeshStandardMaterial({color: 0xffffff, roughness: 0.3});
            group.add(new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.8, 1.8, 64), matWhite));
            const handle = new THREE.Mesh(new THREE.TorusGeometry(0.5, 0.12, 16, 100, Math.PI), matWhite);
            handle.rotation.z = -Math.PI/2; handle.position.set(0.8, 0, 0); group.add(handle);

            // Área Impressão
            const printGeo = new THREE.CylinderGeometry(0.805, 0.805, 1.6, 64, 1, true, Math.PI - (2*Math.PI*0.85/2), 2*Math.PI*0.85);
            const printMat = new THREE.MeshStandardMaterial({transparent: true, side: THREE.DoubleSide});
            printMesh = new THREE.Mesh(printGeo, printMat);
            printMesh.rotation.y = Math.PI / 2;
            group.add(printMesh);

            scene.add(group);

            let dragging = false, lastX = 0;
            function animate() {
                requestAnimationFrame(animate);
                if(!dragging) group.rotation.y += 0.002;
                renderer.render(scene, camera);
            }
            animate();

            container.onmousedown = (e) => { dragging = true; lastX = e.offsetX; };
            window.onmouseup = () => dragging = false;
            container.onmousemove = (e) => {
                if(dragging) { group.rotation.y += (e.offsetX - lastX) * 0.01; lastX = e.offsetX; }
            };
        }
        init3D();

        document.getElementById('btnApply').onclick = () => {
            if(state.floatingImg) return alert("Fixe a imagem primeiro.");
            const tex = new THREE.CanvasTexture(canvas);
            printMesh.material.map = tex;
            printMesh.material.map.needsUpdate = true;
            printMesh.material.needsUpdate = true;
        };

        // === MÓDULO 6: API E ENVIO (BACKEND ATUALIZADO) ===
        document.getElementById('btnSend').onclick = async () => {
            // Validação de Campos
            const email = document.getElementById('userEmail').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            
            if(!email && !phone) {
                return alert("Por favor, preencha o E-mail OU o Telefone para identificarmos seu pedido.");
            }

            // Validação estrita do telefone se estiver preenchido
            if(phone) {
                const cleanPhone = phone.replace(/\D/g, ''); // Remove tudo que não é número
                if(cleanPhone.length < 12) {
                    return alert("Telefone incompleto. Por favor, insira o padrão completo:\nCódigo do País + DDD + Número\nEx: 55 41 99999-9999");
                }
            }
            
            if(!confirm("Salvar pedido no servidor?")) return;

            loadingOverlay.style.display = 'flex';
            loadingText.innerText = "Gerando PDF...";

            try {
                // 1. Gera PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: [210, 99] });
                const imgData = canvas.toDataURL("image/jpeg", 0.95);
                pdf.addImage(imgData, 'JPEG', 0, 0, 210, 99);
                
                // Converte para Base64 (Binário Seguro)
                const pdfArray = pdf.output('arraybuffer');
                let binaryString = "";
                const bytes = new Uint8Array(pdfArray);
                for (let i = 0; i < bytes.byteLength; i++) {
                    binaryString += String.fromCharCode(bytes[i]);
                }
                const pdfBase64 = btoa(binaryString);
                
                // Gera ID no formato AAAAMMDDHHMM
                const now = new Date();
                const pad = n => n.toString().padStart(2, '0');
                const orderId = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}`;
                
                // Define identificador do arquivo (Prioriza Email, se não, usa Telefone limpo)
                const contactId = email ? email : phone.replace(/\D/g, '');
                const filename = `${orderId}_${contactId}.pdf`;

                // 2. Prepara Envio
                loadingText.innerText = "Enviando...";
                const payload = {
                    filename: filename,
                    mimeType: "application/pdf",
                    data: pdfBase64,
                    email: email, // Envia vazio se não tiver, o script trata
                    phone: phone,
                    orderId: orderId
                };

                // 3. Envia para Google Apps Script
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' }, 
                    body: JSON.stringify(payload)
                });

                loadingOverlay.style.display = 'none';
                
                // Mensagem de Sucesso Condicional
                let msg = `Pedido #${orderId} SALVO COM SUCESSO!\n`;
                if(email) {
                    msg += "O arquivo foi compartilhado com seu Google Drive (verifique o aviso do Google).\n";
                }
                msg += "\nPara confirmar prazos e valores, envie este número de pedido para:\n+55 (41) 99674-3862";
                
                alert(msg);

            } catch (err) {
                loadingOverlay.style.display = 'none';
                console.error(err);
                if(confirm("Erro de conexão.\nDeseja baixar o PDF e enviar manualmente?")) {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: [210, 99] });
                    pdf.addImage(canvas.toDataURL(), 'JPEG', 0, 0, 210, 99);
                    pdf.save(`${Date.now()}_manual.pdf`);
                }
            }
        };
    </script>
</body>
</html>

